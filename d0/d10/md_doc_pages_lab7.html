<!-- HTML header for doxygen 1.9.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Microprocessor 2 Labs: Lab 7 Peripherals and Queues: ADC and PWM (LEDC)</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../microprocessor_2_template.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../university_of_texas_at_el_paso_logo-2.png"/></td>
  <td id="projectalign">
   <div id="projectname">Microprocessor 2 Labs<span id="projectnumber">&#160;v2.0</span>
   </div>
   <div id="projectbrief">Microprocessor 2 Lab Documenation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<head>
  <html> 
  <head>
      <!-- ... other metadata & script includes ... -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript">
          DoxygenAwesomeDarkModeToggle.init()
      </script>
  </head>
  <body>
<html>
  <head>
      <!-- ... other metadata & script includes ... -->
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript">
          DoxygenAwesomeFragmentCopyButton.init()
      </script>
  </head>
  <body>
<html>
    <head>
      <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template" class="github-corner" title="View source on GitHub" target="_blank">
        <svg viewBox="0 0 250 250" width="50" height="50" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </head>
    <body>
  <!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d10/md_doc_pages_lab7.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Lab 7 Peripherals and Queues: ADC and PWM (LEDC) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md90"></a>
Objective</h1>
<ul>
<li>The objective for this lab is to understand how use the Espressif <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/ledc.html"><code>LEDC</code></a> and <a href="https://docs.espressif.com/projects/esp-idf/en/v4.2/esp32/api-reference/peripherals/adc.html"><code>ADC</code></a> drivers. In this lab, create 2 task: adc and pwm task. The <code>adc task</code> perform ADC readings every 100 millisecond (10 hertz). This task must store the adc reading and be sent through a queue. Lastly, <code>pwm task</code> should receive the queue data from the <code>adc task</code> and update <code>ledc</code> duty cycle. <div align="center"> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Task   </th><th class="markdownTableHeadLeft">Description   </th><th class="markdownTableHeadLeft">Queue    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>adc_task</code>   </td><td class="markdownTableBodyLeft">Read analog value @ 10 hz   </td><td class="markdownTableBodyLeft">send data    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>pwm_task</code>   </td><td class="markdownTableBodyLeft">Update duty cycle   </td><td class="markdownTableBodyLeft">receive data   </td></tr>
</table>
</div></li>
</ul>
<h1><a class="anchor" id="autotoc_md91"></a>
Bonus</h1>
<ul>
<li><em><b>Undergrad Bonus</b></em><ul>
<li>Add <code>gpio</code> interrupt to start and stop <b>PWM</b> signal</li>
</ul>
</li>
<li><em><b>Grad Bonus</b></em><ul>
<li>Modifiy code to use <b>2</b> more PWM pins.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md92"></a>
ESP32 Pinout</h1>
<div class="fragment"><div class="line">                                        +-----------------------+</div>
<div class="line">                                        | O      | USB |      O |</div>
<div class="line">                                        |        -------        |</div>
<div class="line">                                    3V3 | [ ]               [ ] | VIN</div>
<div class="line">                                    GND | [ ]               [ ] | GND</div>
<div class="line">    Touch3 / HSPI_CS0 / ADC2_3 / GPIO15 | [ ]               [ ] | GPIO13 / ADC2_4 / HSPI_ID / Touch4</div>
<div class="line">CS / Touch2 / HSPI_WP / ADC2_2 /  GPIO2 | [ ]               [ ] | GPIO12 / ADC2_5 / HSPI_Q / Touch5</div>
<div class="line">     Touch0 / HSPI_HD / ADC2_0 /  GPIO4 | [ ]               [ ] | GPIO14 / ADC2_6 / HSPI_CLK / Touch6</div>
<div class="line">                        U2_RXD / GPIO16 | [ ]               [ ] | GPIO27 / ADC2_7 / Touch7</div>
<div class="line">                        U2_TXD / GPIO17 | [ ]               [ ] | GPIO26 / ADC2_9 / DAC2</div>
<div class="line">                     V_SPI_CS0 /  GPIO5 | [ ]  ___________  [ ] | GPIO25 / ADC2_8 / DAC1</div>
<div class="line">               SCK / V_SPI_CLK / GPIO18 | [ ] |           | [ ] | GPIO33 / ADC1_5 / Touch8 / XTAL32</div>
<div class="line">       U0_CTS / MSIO / V_SPI_Q / GPIO19 | [ ] |           | [ ] | GPIO32 / ADC1_4 / Touch9 / XTAL32</div>
<div class="line">                SDA / V_SPI_HD / GPIO21 | [ ] |           | [ ] | GPIO35 / ADC1_7 </div>
<div class="line">                 CLK2 / U0_RXD /  GPIO3 | [ ] |           | [ ] | GPIO34 / ADC1_6 </div>
<div class="line">                 CLK3 / U0_TXD /  GPIO1 | [ ] |           | [ ] | GPIO39 / ADC1_3 / SensVN </div>
<div class="line">       SCL / U0_RTS / V_SPI_WP / GPIO22 | [ ] |           | [ ] | GPIO36 / ADC1_0 / SensVP </div>
<div class="line">               MOSI / V_SPI_WP / GPIO23 | [ ] |___________| [ ] | EN </div>
<div class="line">                                        |                       |</div>
<div class="line">                                        |  |  |  ____  ____  |  |</div>
<div class="line">                                        |  |  |  |  |  |  |  |  |</div>
<div class="line">                                        |  |__|__|  |__|  |__|  |</div>
<div class="line">                                        | O                   O |</div>
<div class="line">                                        +-----------------------+</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md93"></a>
Example 1</h1>
<p >Here is an example of a single ADC channel that will read and print value to the screen. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;driver/adc.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* ADC task */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#aa4ac14df5a56a681fb69aef5cffc5e95">ADCtask</a>(<span class="keywordtype">void</span> *pvParameters){</div>
<div class="line">    <span class="keywordflow">while</span>(1){</div>
<div class="line">        <span class="comment">/* Read adc value @ CHANNEL 6*/</span></div>
<div class="line">        <span class="keywordtype">int</span> val = adc1_get_raw(ADC1_CHANNEL_6);   </div>
<div class="line">        vTaskDelay(100/portTICK_PERIOD_MS); <span class="comment">/* 100 ms */</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Print reading */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;ADC val: %d\n&quot;</span>, val);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Set ADC */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a3c5d2bf67a701f0cb6556568addb2266">adc_setup</a>(<span class="keywordtype">void</span>){</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*Set the ADC with @ 12 bits -&gt; 2^12 = 4096*/</span></div>
<div class="line">    adc1_config_width(ADC_WIDTH_BIT_12);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*Set CHANNEL 6 @ 2600 mV*/</span></div>
<div class="line">    adc1_config_channel_atten(ADC1_CHANNEL_6, ADC_ATTEN_DB_11); </div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>(<span class="keywordtype">void</span>){</div>
<div class="line">    <span class="comment">/* set ADC*/</span></div>
<div class="line">    <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a3c5d2bf67a701f0cb6556568addb2266">adc_setup</a>();</div>
<div class="line">    <span class="comment">/* Create Tasks */</span></div>
<div class="line">    xTaskCreate(&amp;<a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#aa4ac14df5a56a681fb69aef5cffc5e95">ADCtask</a>, <span class="stringliteral">&quot;ADCtask&quot;</span>, 2048,NULL, 5, NULL);</div>
<div class="line">}</div>
<div class="ttc" id="a_additional___labs_2_lab__10_2main_8c_html_abce06be17fc37d675118a678a8100a36"><div class="ttname"><a href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a></div><div class="ttdeci">void app_main()</div><div class="ttdef"><b>Definition:</b> main.c:316</div></div>
<div class="ttc" id="a_lab__7_2main_2main_8c_html_a3c5d2bf67a701f0cb6556568addb2266"><div class="ttname"><a href="../../dc/d12/_lab__7_2main_2main_8c.html#a3c5d2bf67a701f0cb6556568addb2266">adc_setup</a></div><div class="ttdeci">void adc_setup(void)</div><div class="ttdef"><b>Definition:</b> main.c:60</div></div>
<div class="ttc" id="a_lab__7_2main_2main_8c_html_aa4ac14df5a56a681fb69aef5cffc5e95"><div class="ttname"><a href="../../dc/d12/_lab__7_2main_2main_8c.html#aa4ac14df5a56a681fb69aef5cffc5e95">ADCtask</a></div><div class="ttdeci">void ADCtask(void *pvParameters)</div><div class="ttdef"><b>Definition:</b> main.c:37</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md94"></a>
Example 2</h1>
<p >Here is an example of a PWM signal using the LEDC API to dim an LED. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/queue.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;driver/ledc.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ONBOARD_LED 2  </span><span class="comment">/* Onboard LED */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_DUTY    4096 </span><span class="comment">/* max duty cycle */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* PWM task */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#af449d6a027ba3cff41528f12a08dff32">PWMtask</a>(<span class="keywordtype">void</span> *pvParameters){</div>
<div class="line">    <span class="keywordtype">int</span> i = 0;</div>
<div class="line">    <span class="keywordflow">while</span>(1){</div>
<div class="line">        <span class="comment">/* Iterate over channel 1 duty cycle, increase */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; MAX_DUTY; i += 10){ </div>
<div class="line">            <span class="comment">/* set duty cycle */</span></div>
<div class="line">            ledc_set_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_1,i);</div>
<div class="line">            <span class="comment">/* update duty cycle */</span></div>
<div class="line">            ledc_update_duty(LEDC_LOW_SPEED_MODE,LEDC_CHANNEL_1); <span class="comment">//update duty </span></div>
<div class="line">            vTaskDelay(10/portTICK_PERIOD_MS); <span class="comment">/* 10ms */</span> </div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Iterate over channel 1 duty cycle, decrease */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = MAX_DUTY; i &gt; 0; i -= 10){ </div>
<div class="line">            <span class="comment">/* set duty cycle */</span></div>
<div class="line">            ledc_set_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_1,i);</div>
<div class="line">            <span class="comment">/* update duty cycle */</span></div>
<div class="line">            ledc_update_duty(LEDC_LOW_SPEED_MODE,LEDC_CHANNEL_1); <span class="comment">//update duty </span></div>
<div class="line">            vTaskDelay(10/portTICK_PERIOD_MS); <span class="comment">/* 10ms */</span> </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Set PWM */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a2d1c3e7be837352ae08245dc9396e7e1">pwm_setup</a>(<span class="keywordtype">void</span>){</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Set LEDC Timer:</span></div>
<div class="line"><span class="comment">                        5000hz</span></div>
<div class="line"><span class="comment">                        AUTO_CLK</span></div>
<div class="line"><span class="comment">                        TIMER_1</span></div>
<div class="line"><span class="comment">                        LOW_SPEED</span></div>
<div class="line"><span class="comment">                        13 BIT</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    ledc_timer_config_t timerConfig;</div>
<div class="line">    timerConfig.duty_resolution = LEDC_TIMER_13_BIT; </div>
<div class="line">    timerConfig.timer_num = LEDC_TIMER_1;</div>
<div class="line">    timerConfig.freq_hz = 5000; </div>
<div class="line">    timerConfig.speed_mode = LEDC_LOW_SPEED_MODE;</div>
<div class="line">    timerConfig.clk_cfg = LEDC_AUTO_CLK;</div>
<div class="line">    ledc_timer_config(&amp;timerConfig);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Set LEDC Channel:</span></div>
<div class="line"><span class="comment">                        GPIO_21</span></div>
<div class="line"><span class="comment">                        LOW_SPEED</span></div>
<div class="line"><span class="comment">                        TIMER_1</span></div>
<div class="line"><span class="comment">                        LOW_SPEED</span></div>
<div class="line"><span class="comment">                        0 duty</span></div>
<div class="line"><span class="comment">                        Max duty </span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    ledc_channel_config_t channelConfig;</div>
<div class="line">    channelConfig.gpio_num = <a class="code hl_define" href="../../d2/d6b/_lab__2_2main_2main_8c.html#a547f7691f0e83d2e9fd22bf5b3c08b0a">ONBOARD_LED</a>;    </div>
<div class="line">    channelConfig.speed_mode = LEDC_LOW_SPEED_MODE;</div>
<div class="line">    channelConfig.channel = LEDC_CHANNEL_1;</div>
<div class="line">    channelConfig.intr_type = LEDC_INTR_DISABLE;</div>
<div class="line">    channelConfig.timer_sel = LEDC_TIMER_1;</div>
<div class="line">    channelConfig.duty = 0;</div>
<div class="line">    channelConfig.hpoint = MAX_DUTY;   </div>
<div class="line">    ledc_channel_config(&amp;channelConfig);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>(<span class="keywordtype">void</span>){</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* set PWM*/</span></div>
<div class="line">    <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a2d1c3e7be837352ae08245dc9396e7e1">pwm_setup</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create Tasks */</span></div>
<div class="line">    xTaskCreate(&amp;<a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#af449d6a027ba3cff41528f12a08dff32">PWMtask</a>, <span class="stringliteral">&quot;PWMtask&quot;</span>, 2048, NULL, 5, NULL);</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="ttc" id="a_lab__2_2main_2main_8c_html_a547f7691f0e83d2e9fd22bf5b3c08b0a"><div class="ttname"><a href="../../d2/d6b/_lab__2_2main_2main_8c.html#a547f7691f0e83d2e9fd22bf5b3c08b0a">ONBOARD_LED</a></div><div class="ttdeci">#define ONBOARD_LED</div><div class="ttdef"><b>Definition:</b> main.c:30</div></div>
<div class="ttc" id="a_lab__7_2main_2main_8c_html_a2d1c3e7be837352ae08245dc9396e7e1"><div class="ttname"><a href="../../dc/d12/_lab__7_2main_2main_8c.html#a2d1c3e7be837352ae08245dc9396e7e1">pwm_setup</a></div><div class="ttdeci">void pwm_setup(void)</div><div class="ttdef"><b>Definition:</b> main.c:66</div></div>
<div class="ttc" id="a_lab__7_2main_2main_8c_html_af449d6a027ba3cff41528f12a08dff32"><div class="ttname"><a href="../../dc/d12/_lab__7_2main_2main_8c.html#af449d6a027ba3cff41528f12a08dff32">PWMtask</a></div><div class="ttdeci">void PWMtask(void *pvParameters)</div><div class="ttdef"><b>Definition:</b> main.c:48</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md95"></a>
Lab Template</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/queue.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;driver/ledc.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;driver/adc.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Global queue handle */</span></div>
<div class="line">QueueHandle_t <a class="code hl_variable" href="../../dc/d12/_lab__7_2main_2main_8c.html#a1dbfc3fa6e8af6057fc4ee35f29c064f">duty_queue</a> = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* ADC task */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#aa4ac14df5a56a681fb69aef5cffc5e95">ADCtask</a>(<span class="keywordtype">void</span> *pvParameters)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (1)</div>
<div class="line">    {</div>
<div class="line">       <span class="comment">/* Read adc channel*/</span></div>
<div class="line"> </div>
<div class="line">       <span class="comment">/* Send data to queue */</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* PWM task */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#af449d6a027ba3cff41528f12a08dff32">PWMtask</a>(<span class="keywordtype">void</span> *pvParameters)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Receive data */</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Update duty cycle */</span></div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* ADC setup */</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a3c5d2bf67a701f0cb6556568addb2266">adc_setup</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Set adc */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* PWM setup */</span> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#a2d1c3e7be837352ae08245dc9396e7e1">pwm_setup</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Setup ADC and PWM */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create queue */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create tasks */</span></div>
<div class="line">    xTaskCreate(&amp;<a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#aa4ac14df5a56a681fb69aef5cffc5e95">ADCtask</a>, <span class="stringliteral">&quot;ADCtask&quot;</span>, 2048, NULL, 5, NULL);</div>
<div class="line">    xTaskCreate(&amp;<a class="code hl_function" href="../../dc/d12/_lab__7_2main_2main_8c.html#af449d6a027ba3cff41528f12a08dff32">PWMtask</a>, <span class="stringliteral">&quot;PWMtask&quot;</span>, 2048, NULL, 5, NULL);</div>
<div class="line">}</div>
<div class="ttc" id="a_lab__7_2main_2main_8c_html_a1dbfc3fa6e8af6057fc4ee35f29c064f"><div class="ttname"><a href="../../dc/d12/_lab__7_2main_2main_8c.html#a1dbfc3fa6e8af6057fc4ee35f29c064f">duty_queue</a></div><div class="ttdeci">QueueHandle_t duty_queue</div><div class="ttdef"><b>Definition:</b> main.c:34</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md96"></a>
C helpful functions</h1>
<p >Espressif ADC driver requires the following structures and enumeration inorder to set the correct pin and operation. There are a few GPIO that are avaiable to use analog converter. Depending on the ESP32, there are slight difference between the pinout so please verify the hardware. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    ADC1_CHANNEL_0 = 0, </div>
<div class="line">    ADC1_CHANNEL_1,     </div>
<div class="line">    ADC1_CHANNEL_2,     </div>
<div class="line">    ADC1_CHANNEL_3,     </div>
<div class="line">    ADC1_CHANNEL_4,     </div>
<div class="line">    ADC1_CHANNEL_5,     </div>
<div class="line">    ADC1_CHANNEL_6,     </div>
<div class="line">    ADC1_CHANNEL_7,     </div>
<div class="line">    ADC1_CHANNEL_MAX,</div>
<div class="line">} adc1_channel_t;</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    ADC2_CHANNEL_0 = 0, </div>
<div class="line">    ADC2_CHANNEL_1,     </div>
<div class="line">    ADC2_CHANNEL_2,     </div>
<div class="line">    ADC2_CHANNEL_3,     </div>
<div class="line">    ADC2_CHANNEL_4,     </div>
<div class="line">    ADC2_CHANNEL_5,     </div>
<div class="line">    ADC2_CHANNEL_6,     </div>
<div class="line">    ADC2_CHANNEL_7,     </div>
<div class="line">    ADC2_CHANNEL_8,     </div>
<div class="line">    ADC2_CHANNEL_9,     </div>
<div class="line">    ADC2_CHANNEL_MAX,</div>
<div class="line">} adc2_channel_t;</div>
</div><!-- fragment --><p> The ESP has default 12 bit max width conversion but depending on the hardware, it can go upto 13 bit. To keep everything simple, please do not exceed 12 bit width. Espressif ADC width is selected by <code>adc_bit_width_t</code> enumeration down below. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line"><span class="preprocessor">#if CONFIG_IDF_TARGET_ESP32</span></div>
<div class="line">    ADC_WIDTH_BIT_9  = 0, </div>
<div class="line">    ADC_WIDTH_BIT_10 = 1, </div>
<div class="line">    ADC_WIDTH_BIT_11 = 2, </div>
<div class="line">    ADC_WIDTH_BIT_12 = 3, </div>
<div class="line"><span class="preprocessor">#elif SOC_ADC_MAX_BITWIDTH == 12</span></div>
<div class="line">    ADC_WIDTH_BIT_12 = 3, </div>
<div class="line"><span class="preprocessor">#elif SOC_ADC_MAX_BITWIDTH == 13</span></div>
<div class="line">    ADC_WIDTH_BIT_13 = 4, </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    ADC_WIDTH_MAX,</div>
<div class="line">} adc_bits_width_t;</div>
</div><!-- fragment --><p >Espressif ADC driver has an attenuation feature to limit voltage reading to desire range. The <code>adc_atten_t</code> enumeration allows to select desire range of the adc channel. Please go over the example program to get an idea of how the <b>ADC</b> driver works. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    ADC_ATTEN_DB_0   = 0,  </div>
<div class="line">    ADC_ATTEN_DB_2_5 = 1,  </div>
<div class="line">    ADC_ATTEN_DB_6   = 2,  </div>
<div class="line">    ADC_ATTEN_DB_11  = 3,  </div>
<div class="line">} adc_atten_t;</div>
</div><!-- fragment --><p >Next, Espressif LEDC driver requires to use the following structures. <code>ledc_timer_config_t</code> structure set the duty resolution, timer, frequency and clock source. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    ledc_mode_t speed_mode;                </div>
<div class="line">    <span class="keyword">union </span>{</div>
<div class="line">        ledc_timer_bit_t duty_resolution;  </div>
<div class="line">        ledc_timer_bit_t bit_num __attribute__((deprecated)); </div>
<div class="line">    };</div>
<div class="line">    ledc_timer_t  timer_num;               </div>
<div class="line">    uint32_t freq_hz;                      </div>
<div class="line">    ledc_clk_cfg_t clk_cfg;                </div>
<div class="line">} ledc_timer_config_t;</div>
</div><!-- fragment --><p> Furthermore, <code>ledc_channel_config_t</code> structure allows to select the pin number, speed mode, channel, intr type, timer select, duty cycle and hpoint. For more detail, please see Espressif documentation and go over the example programs to understand how to use it properly. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">int</span> gpio_num;                   </div>
<div class="line">    ledc_mode_t speed_mode;         </div>
<div class="line">    ledc_channel_t channel;         </div>
<div class="line">    ledc_intr_type_t intr_type;     </div>
<div class="line">    ledc_timer_t timer_sel;         </div>
<div class="line">    uint32_t duty;                  </div>
<div class="line">    <span class="keywordtype">int</span> hpoint;                     </div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> output_invert: 1;</div>
<div class="line">    } flags;                        </div>
<div class="line">} ledc_channel_config_t;</div>
</div><!-- fragment --><p> Additionally, <code>ledc_set_duty(ledc_mode_t speed_mode, ledc_channel_t channel, uint32_t duty)</code> is use to set the duty cycle and to actually update the duty you need to use <code>ledc_update_duty(ledc_mode_t speed_mode, ledc_channel_t channel)</code>. Lastly, <code>LEDC</code> driver allows users to control the operation of the timer: <code>ledc_timer_pause(ledc_mode_t speed_mode, ledc_timer_t timer_sel)</code> and <code>ledc_timer_resume(ledc_mode_t speed_mode, ledc_timer_t timer_sel)</code>.</p>
<h1><a class="anchor" id="autotoc_md97"></a>
Additional Links</h1>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html#">Espressif GPIO Driver API</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/adc.html">Espressif ADC Driver API</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/ledc.html">Espressif LEDC Driver API</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md98"></a>
Authors</h1>
<ul>
<li><a href="https://github.com/jminjares4"><b>Jesus Minjares</b></a><ul>
<li><b>Master of Science in Computer Engineering</b> <br  />
 <a href="https://www.linkedin.com/in/jesusminjares/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white&amp;style=flat" alt="LinkedIn" class="inline"/></a> <a href="https://github.com/jminjares4"><img src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&amp;logo=github&amp;logoColor=white&amp;style=flat" alt="GitHub" class="inline"/></a></li>
</ul>
</li>
<li><a href="https://github.com/eabaca2419"><b>Erick Baca</b></a><ul>
<li><b>Master of Science in Computer Engineering</b> <br  />
 <a href="https://www.linkedin.com/in/erick-baca/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white&amp;style=flat" alt="LinkedIn" class="inline"/></a> <a href="https://github.com/eabaca2419"><img src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&amp;logo=github&amp;logoColor=white&amp;style=flat" alt="GitHub" class="inline"/></a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md99"></a>
GitHub</h1>
<div align="left"> <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template/tree/main/Lab_7"><img src="../../github.png" alt="" class="inline"/> </a> <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template/tree/main/Lab_7">Lab 7 Repository</a> </div><p ><span class="next_section_button"> Read Next: <a class="el" href="../../dc/df4/md_doc_pages_lab8.html">Lab 8</a> </span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="footer"><a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template"><img class="footer" src="../../university_of_texas_at_el_paso_logo.png" width="104" height="31" alt="doxygen"/></a> v2.0 </li>
    </ul>
  </div>
  </body>
  </html>
  