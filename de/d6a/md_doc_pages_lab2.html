<!-- HTML header for doxygen 1.9.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Microprocessor 2 Labs: Lab 2 Interrupts: Fire Alarm!</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../microprocessor_2_template.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../university_of_texas_at_el_paso_logo-2.png"/></td>
  <td id="projectalign">
   <div id="projectname">Microprocessor 2 Labs<span id="projectnumber">&#160;v2.0</span>
   </div>
   <div id="projectbrief">Microprocessor 2 Lab Documenation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<head>
  <html> 
  <head>
      <!-- ... other metadata & script includes ... -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript">
          DoxygenAwesomeDarkModeToggle.init()
      </script>
  </head>
  <body>
<html>
  <head>
      <!-- ... other metadata & script includes ... -->
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript">
          DoxygenAwesomeFragmentCopyButton.init()
      </script>
  </head>
  <body>
<html>
    <head>
      <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template" class="github-corner" title="View source on GitHub" target="_blank">
        <svg viewBox="0 0 250 250" width="50" height="50" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </head>
    <body>
  <!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/d6a/md_doc_pages_lab2.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Lab 2 Interrupts: Fire Alarm! </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md32"></a>
Objective</h1>
<ul>
<li>Understand how to use the <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html#api-reference-normal-gpio">Espressif GPIO interrupts</a>. This lab will consist of simulating your own <b>fire alarm</b>!!! There is an additional driver that was developed to facilitate the use of LEDs. Student must use 2 external interrupts either pull-up or pull-down configuration.</li>
</ul>
<h1><a class="anchor" id="autotoc_md33"></a>
Bonus</h1>
<ul>
<li><b>Undergrad Bonus:</b><ul>
<li>Display fire alarm <code>status</code> in terminal whenever it is <b>active</b></li>
</ul>
</li>
<li><b>Grad Bonus:</b><ul>
<li>Add another <code>LED</code> to indicate when <em>fire alarm</em> is <b>disable</b></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md34"></a>
ESP32 Pinout</h1>
<div class="fragment"><div class="line">                                        +-----------------------+</div>
<div class="line">                                        | O      | USB |      O |</div>
<div class="line">                                        |        -------        |</div>
<div class="line">                                    3V3 | [ ]               [ ] | VIN</div>
<div class="line">                                    GND | [ ]               [ ] | GND</div>
<div class="line">    Touch3 / HSPI_CS0 / ADC2_3 / GPIO15 | [ ]               [ ] | GPIO13 / ADC2_4 / HSPI_ID / Touch4</div>
<div class="line">CS / Touch2 / HSPI_WP / ADC2_2 /  GPIO2 | [ ]               [ ] | GPIO12 / ADC2_5 / HSPI_Q / Touch5</div>
<div class="line">     Touch0 / HSPI_HD / ADC2_0 /  GPIO4 | [ ]               [ ] | GPIO14 / ADC2_6 / HSPI_CLK / Touch6</div>
<div class="line">                        U2_RXD / GPIO16 | [ ]               [ ] | GPIO27 / ADC2_7 / Touch7</div>
<div class="line">                        U2_TXD / GPIO17 | [ ]               [ ] | GPIO26 / ADC2_9 / DAC2</div>
<div class="line">                     V_SPI_CS0 /  GPIO5 | [ ]  ___________  [ ] | GPIO25 / ADC2_8 / DAC1</div>
<div class="line">               SCK / V_SPI_CLK / GPIO18 | [ ] |           | [ ] | GPIO33 / ADC1_5 / Touch8 / XTAL32</div>
<div class="line">       U0_CTS / MSIO / V_SPI_Q / GPIO19 | [ ] |           | [ ] | GPIO32 / ADC1_4 / Touch9 / XTAL32</div>
<div class="line">                SDA / V_SPI_HD / GPIO21 | [ ] |           | [ ] | GPIO35 / ADC1_7 </div>
<div class="line">                 CLK2 / U0_RXD /  GPIO3 | [ ] |           | [ ] | GPIO34 / ADC1_6 </div>
<div class="line">                 CLK3 / U0_TXD /  GPIO1 | [ ] |           | [ ] | GPIO39 / ADC1_3 / SensVN </div>
<div class="line">       SCL / U0_RTS / V_SPI_WP / GPIO22 | [ ] |           | [ ] | GPIO36 / ADC1_0 / SensVP </div>
<div class="line">               MOSI / V_SPI_WP / GPIO23 | [ ] |___________| [ ] | EN </div>
<div class="line">                                        |                       |</div>
<div class="line">                                        |  |  |  ____  ____  |  |</div>
<div class="line">                                        |  |  |  |  |  |  |  |  |</div>
<div class="line">                                        |  |__|__|  |__|  |__|  |</div>
<div class="line">                                        | O                   O |</div>
<div class="line">                                        +-----------------------+</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md35"></a>
Example</h1>
<p >Here is an example of how to use ESP32 GPIO advance setup. The following code will have an external LED toggling every half second and will toggle the onboard led if the button is pressed.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span> </div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span> </div>
<div class="line"><span class="preprocessor">#include &quot;driver/gpio.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ESP_INTR_FLAG_DEFAULT 0 </span><span class="comment">/* Interrupt flag configuration */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define LOW     0   </span><span class="comment">/* low logic  */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define HIGH    1   </span><span class="comment">/* high logic */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ONBOARD_LED     2    </span><span class="comment">/* onboard led pin  */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define EXTERNAL_LED    22   </span><span class="comment">/* external led pin  */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BUTTON          23   </span><span class="comment">/* button pin  */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> toggle(gpio_num_t pin){</div>
<div class="line">    <span class="comment">/* Get current level and toggle LED */</span></div>
<div class="line">    gpio_get_level(pin) ? gpio_set_level(pin, <a class="code hl_define" href="../../d3/db7/_lab__0_2main_2main_8c.html#ab811d8c6ff3a505312d3276590444289">LOW</a>) : gpio_set_level(pin, <a class="code hl_define" href="../../d3/db7/_lab__0_2main_2main_8c.html#a5bb885982ff66a2e0a0a45a8ee9c35e2">HIGH</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* GPIO interrupt handler */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> IRAM_ATTR gpio_isr_handler(<span class="keywordtype">void</span>* arg) {</div>
<div class="line">    <span class="comment">/* store argument */</span></div>
<div class="line">    gpio_num_t gpio = (gpio_num_t) arg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* toggle LED */</span></div>
<div class="line">    toggle(gpio);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* GPIO setup */</span></div>
<div class="line"><span class="keywordtype">void</span> gpio_setup(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">/* IO configuration */</span></div>
<div class="line">    gpio_config_t io_conf;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Input configuration */</span></div>
<div class="line">    io_conf.intr_type = GPIO_INTR_POSEDGE;  <span class="comment">/* Set up as Positive Edge */</span> </div>
<div class="line">    io_conf.mode = GPIO_MODE_INPUT;     <span class="comment">/* Set pins as input */</span></div>
<div class="line">    io_conf.pin_bit_mask = (1ULL &lt;&lt; BUTTON);  <span class="comment">/* Add input bit mask */</span></div>
<div class="line">    io_conf.pull_down_en = 1;   <span class="comment">/* Enable pulldown */</span></div>
<div class="line">    io_conf.pull_up_en = 0;     <span class="comment">/* Disable pullup */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set configuration */</span></div>
<div class="line">    gpio_config(&amp;io_conf);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Output configuration */</span></div>
<div class="line">    io_conf.intr_type = GPIO_INTR_DISABLE;  <span class="comment">/* Disable interrupt */</span></div>
<div class="line">    io_conf.mode = GPIO_MODE_OUTPUT;        <span class="comment">/* Set as output*/</span></div>
<div class="line">    io_conf.pin_bit_mask = (1ULL &lt;&lt; <a class="code hl_define" href="../../d2/d6b/_lab__2_2main_2main_8c.html#a547f7691f0e83d2e9fd22bf5b3c08b0a">ONBOARD_LED</a>) | (1ULL &lt;&lt; EXTERNAL_LED); <span class="comment">/* Add output bit mask */</span></div>
<div class="line">    io_conf.pull_down_en = 0;   <span class="comment">/* Disable pulldown */</span></div>
<div class="line">    io_conf.pull_up_en = 0;     <span class="comment">/* Disable pullup */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set configuration */</span></div>
<div class="line">    gpio_config(&amp;io_conf);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set default interrupt flag */</span></div>
<div class="line">    gpio_install_isr_service(<a class="code hl_define" href="../../d2/d6b/_lab__2_2main_2main_8c.html#af8baf7d9859733667317e58c0ff707d1">ESP_INTR_FLAG_DEFAULT</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Add ISR handler */</span></div>
<div class="line">    gpio_isr_handler_add(BUTTON, gpio_isr_handler, (<span class="keywordtype">void</span>*) BUTTON); </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>() {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Setup the GPIOs */</span></div>
<div class="line">    gpio_setup();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1){</div>
<div class="line">         toggle(EXTERNAL_LED); <span class="comment">/* Toggle external led */</span></div>
<div class="line">         vTaskDelay(500/portTICK_PERIOD_MS); <span class="comment">/* .5 second delay */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="a_additional___labs_2_lab__10_2main_8c_html_abce06be17fc37d675118a678a8100a36"><div class="ttname"><a href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a></div><div class="ttdeci">void app_main()</div><div class="ttdef"><b>Definition:</b> main.c:316</div></div>
<div class="ttc" id="a_lab__0_2main_2main_8c_html_a5bb885982ff66a2e0a0a45a8ee9c35e2"><div class="ttname"><a href="../../d3/db7/_lab__0_2main_2main_8c.html#a5bb885982ff66a2e0a0a45a8ee9c35e2">HIGH</a></div><div class="ttdeci">#define HIGH</div><div class="ttdef"><b>Definition:</b> main.c:28</div></div>
<div class="ttc" id="a_lab__0_2main_2main_8c_html_ab811d8c6ff3a505312d3276590444289"><div class="ttname"><a href="../../d3/db7/_lab__0_2main_2main_8c.html#ab811d8c6ff3a505312d3276590444289">LOW</a></div><div class="ttdeci">#define LOW</div><div class="ttdef"><b>Definition:</b> main.c:27</div></div>
<div class="ttc" id="a_lab__2_2main_2main_8c_html_a547f7691f0e83d2e9fd22bf5b3c08b0a"><div class="ttname"><a href="../../d2/d6b/_lab__2_2main_2main_8c.html#a547f7691f0e83d2e9fd22bf5b3c08b0a">ONBOARD_LED</a></div><div class="ttdeci">#define ONBOARD_LED</div><div class="ttdef"><b>Definition:</b> main.c:30</div></div>
<div class="ttc" id="a_lab__2_2main_2main_8c_html_af8baf7d9859733667317e58c0ff707d1"><div class="ttname"><a href="../../d2/d6b/_lab__2_2main_2main_8c.html#af8baf7d9859733667317e58c0ff707d1">ESP_INTR_FLAG_DEFAULT</a></div><div class="ttdeci">#define ESP_INTR_FLAG_DEFAULT</div><div class="ttdef"><b>Definition:</b> main.c:28</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md36"></a>
LED driver Example</h1>
<p >Here is an example of a how to use the <a class="el" href="../../db/da0/led_8h.html">led driver</a>. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../db/da0/led_8h.html">driver/led.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>(<span class="keywordtype">void</span>){</div>
<div class="line">    <span class="comment">/* Initialize led objects */</span></div>
<div class="line">    <a class="code hl_struct" href="../../d0/dbe/structled__t.html">led_t</a> onboard_led = { .<a class="code hl_variable" href="../../d0/dbe/structled__t.html#ac9e5f6e409f17ed146f5fbbaccbaa59e">pin</a> = 2, .state = <a class="code hl_enumvalue" href="../../db/da0/led_8h.html#aa0aafed44fec19806d8f9ad834be1248aac132f2982b98bcaa3445e535a03ff75">OFF</a>};</div>
<div class="line">    <a class="code hl_struct" href="../../d0/dbe/structled__t.html">led_t</a> external_led = { .<a class="code hl_variable" href="../../d0/dbe/structled__t.html#ac9e5f6e409f17ed146f5fbbaccbaa59e">pin</a> = 16, .state = <a class="code hl_enumvalue" href="../../db/da0/led_8h.html#aa0aafed44fec19806d8f9ad834be1248aac132f2982b98bcaa3445e535a03ff75">OFF</a>};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Enable led */</span></div>
<div class="line">    <a class="code hl_function" href="../../db/da0/led_8h.html#a87a224762512cf96735b307b3a302bb9">led_enable</a>(&amp;onboard_led);</div>
<div class="line">    <a class="code hl_function" href="../../db/da0/led_8h.html#a87a224762512cf96735b307b3a302bb9">led_enable</a>(&amp;external_led);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1){</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_function" href="../../db/da0/led_8h.html#ac9c8974b9359d2c4b9185b21a9e6661c">led_toggle</a>(&amp;onboard_led);               <span class="comment">/* toggle onboard led */</span></div>
<div class="line">        <a class="code hl_function" href="../../db/da0/led_8h.html#a9d8a79162be2befa7d97f6147b0b866d">led_on</a>(&amp;external_led);                  <span class="comment">/* turn on external led */</span></div>
<div class="line">        vTaskDelay(1000 / portTICK_PERIOD_MS);  <span class="comment">/* 1 second delay */</span></div>
<div class="line">        <a class="code hl_function" href="../../db/da0/led_8h.html#a2dbc4fe5247b1fe01352d35cc2c1f209">led_off</a>(&amp;external_led);                 <span class="comment">/* turn off external led */</span></div>
<div class="line">        vTaskDelay(100 / portTICK_PERIOD_MS);   <span class="comment">/* 100 ms delay */</span></div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aled_8h_html"><div class="ttname"><a href="../../db/da0/led_8h.html">led.h</a></div><div class="ttdoc">Custom LED driver header file.</div></div>
<div class="ttc" id="aled_8h_html_a2dbc4fe5247b1fe01352d35cc2c1f209"><div class="ttname"><a href="../../db/da0/led_8h.html#a2dbc4fe5247b1fe01352d35cc2c1f209">led_off</a></div><div class="ttdeci">void led_off(led_t *const led)</div><div class="ttdoc">Turn off LED object pin.</div><div class="ttdef"><b>Definition:</b> led.c:63</div></div>
<div class="ttc" id="aled_8h_html_a87a224762512cf96735b307b3a302bb9"><div class="ttname"><a href="../../db/da0/led_8h.html#a87a224762512cf96735b307b3a302bb9">led_enable</a></div><div class="ttdeci">void led_enable(led_t *const led)</div><div class="ttdoc">LED enable.</div><div class="ttdef"><b>Definition:</b> led.c:27</div></div>
<div class="ttc" id="aled_8h_html_a9d8a79162be2befa7d97f6147b0b866d"><div class="ttname"><a href="../../db/da0/led_8h.html#a9d8a79162be2befa7d97f6147b0b866d">led_on</a></div><div class="ttdeci">void led_on(led_t *const led)</div><div class="ttdoc">Turn on LED object pin.</div><div class="ttdef"><b>Definition:</b> led.c:50</div></div>
<div class="ttc" id="aled_8h_html_aa0aafed44fec19806d8f9ad834be1248aac132f2982b98bcaa3445e535a03ff75"><div class="ttname"><a href="../../db/da0/led_8h.html#aa0aafed44fec19806d8f9ad834be1248aac132f2982b98bcaa3445e535a03ff75">OFF</a></div><div class="ttdeci">@ OFF</div><div class="ttdef"><b>Definition:</b> led.h:22</div></div>
<div class="ttc" id="aled_8h_html_ac9c8974b9359d2c4b9185b21a9e6661c"><div class="ttname"><a href="../../db/da0/led_8h.html#ac9c8974b9359d2c4b9185b21a9e6661c">led_toggle</a></div><div class="ttdeci">void led_toggle(led_t *const led)</div><div class="ttdoc">Toggle LED object pin.</div><div class="ttdef"><b>Definition:</b> led.c:76</div></div>
<div class="ttc" id="astructled__t_html"><div class="ttname"><a href="../../d0/dbe/structled__t.html">led_t</a></div><div class="ttdoc">LED object.</div><div class="ttdef"><b>Definition:</b> led.h:38</div></div>
<div class="ttc" id="astructled__t_html_ac9e5f6e409f17ed146f5fbbaccbaa59e"><div class="ttname"><a href="../../d0/dbe/structled__t.html#ac9e5f6e409f17ed146f5fbbaccbaa59e">led_t::pin</a></div><div class="ttdeci">gpio_num_t pin</div><div class="ttdef"><b>Definition:</b> led.h:39</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md37"></a>
Lab Template</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;freertos/task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;driver/gpio.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../db/da0/led_8h.html">driver/led.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ESP_INTR_FLAG_DEFAULT   0   </span><span class="comment">/* Interrupt flag configuration */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ONBOARD_LED             2   </span><span class="comment">/* Onboard led */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Update with custom pins */</span></div>
<div class="line"><span class="preprocessor">#define SMOKE_DETECTOR_PIN      0  </span><span class="comment">/* Smoke detector pin */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define DISABLE_ALARM_PIN       0  </span><span class="comment">/* Disable alarm pin */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>{</div>
<div class="line">    <a class="code hl_struct" href="../../d0/dbe/structled__t.html">led_t</a> indicator;            </div>
<div class="line">    gpio_num_t  smokeDetector;  </div>
<div class="line">    gpio_num_t  disableAlarm;   </div>
<div class="line">    <span class="keywordtype">bool</span> active;                </div>
<div class="line">}<a class="code hl_struct" href="../../d8/db4/structfire__alarm__t.html">fire_alarm_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Global fire alarm object */</span></div>
<div class="line"><a class="code hl_struct" href="../../d8/db4/structfire__alarm__t.html">fire_alarm_t</a> <a class="code hl_variable" href="../../d2/d6b/_lab__2_2main_2main_8c.html#af95f3e6cbe25afb526761258f1b12056">utep_alarm</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* GPIO interrupt handler */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> IRAM_ATTR gpio_interrupt_handler(<span class="keywordtype">void</span> * arg) {</div>
<div class="line">    <span class="comment">/* Typecast argument */</span></div>
<div class="line">    gpio_num_t gpio = (gpio_num_t) arg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Check if smoke detector pin has been pressed or disable alarm */</span></div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../d2/d6b/_lab__2_2main_2main_8c.html#a83e34c167ff267499a76636ec568a1c9">fire_alarm_interrupt_setup</a>(<a class="code hl_struct" href="../../d8/db4/structfire__alarm__t.html">fire_alarm_t</a> * <span class="keyword">const</span> alarm){</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* IO configuration */</span></div>
<div class="line">    gpio_config_t io_conf;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Interrupt configuration */</span></div>
<div class="line">    io_conf.intr_type =  ;</div>
<div class="line">    io_conf.mode = ;</div>
<div class="line">    io_conf.pin_bit_mask = ;</div>
<div class="line">    io_conf.pull_down_en = ;</div>
<div class="line">    io_conf.pull_up_en = ;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Set configuration */</span></div>
<div class="line">    gpio_config(&amp;io_conf);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set default interrupt flag */</span></div>
<div class="line">    gpio_install_isr_service(<a class="code hl_define" href="../../d2/d6b/_lab__2_2main_2main_8c.html#af8baf7d9859733667317e58c0ff707d1">ESP_INTR_FLAG_DEFAULT</a>);    </div>
<div class="line">   </div>
<div class="line">    <span class="comment">/* Add ISR handler */</span></div>
<div class="line">    gpio_isr_handler_add(alarm-&gt;<a class="code hl_variable" href="../../d8/db4/structfire__alarm__t.html#a2c671aea37ed0d915f0660a950936e54">smokeDetector</a>, gpio_interrupt_handler, (<span class="keywordtype">void</span> *) alarm-&gt;<a class="code hl_variable" href="../../d8/db4/structfire__alarm__t.html#a2c671aea37ed0d915f0660a950936e54">smokeDetector</a>);</div>
<div class="line">    <span class="comment">/* Add missing interrupt */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../dd/d74/_additional___labs_2_lab__10_2main_8c.html#abce06be17fc37d675118a678a8100a36">app_main</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Initialize fire alarm object */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Enable led*/</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span>(1){</div>
<div class="line">        <span class="comment">/* Check if alarm has been activate */</span></div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code hl_variable" href="../../d2/d6b/_lab__2_2main_2main_8c.html#af95f3e6cbe25afb526761258f1b12056">utep_alarm</a>.<a class="code hl_variable" href="../../d8/db4/structfire__alarm__t.html#a4afb679790ccaa02ebc3ff69cc0ad2aa">active</a>){</div>
<div class="line">            <span class="comment">/* Toggle indicator led @ 500 ms */</span></div>
<div class="line">           </div>
<div class="line">        }<span class="keywordflow">else</span>{</div>
<div class="line">            <span class="comment">/* 100 ms delay */</span></div>
<div class="line">            vTaskDelay(100 / portTICK_PERIOD_MS);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="a_lab__2_2main_2main_8c_html_a83e34c167ff267499a76636ec568a1c9"><div class="ttname"><a href="../../d2/d6b/_lab__2_2main_2main_8c.html#a83e34c167ff267499a76636ec568a1c9">fire_alarm_interrupt_setup</a></div><div class="ttdeci">void fire_alarm_interrupt_setup(fire_alarm_t *const alarm)</div><div class="ttdoc">Set up fire alarm interrupt.</div><div class="ttdef"><b>Definition:</b> main.c:66</div></div>
<div class="ttc" id="a_lab__2_2main_2main_8c_html_af95f3e6cbe25afb526761258f1b12056"><div class="ttname"><a href="../../d2/d6b/_lab__2_2main_2main_8c.html#af95f3e6cbe25afb526761258f1b12056">utep_alarm</a></div><div class="ttdeci">fire_alarm_t utep_alarm</div><div class="ttdef"><b>Definition:</b> main.c:49</div></div>
<div class="ttc" id="astructfire__alarm__t_html"><div class="ttname"><a href="../../d8/db4/structfire__alarm__t.html">fire_alarm_t</a></div><div class="ttdoc">Fire alarm object.</div><div class="ttdef"><b>Definition:</b> main.c:41</div></div>
<div class="ttc" id="astructfire__alarm__t_html_a2c671aea37ed0d915f0660a950936e54"><div class="ttname"><a href="../../d8/db4/structfire__alarm__t.html#a2c671aea37ed0d915f0660a950936e54">fire_alarm_t::smokeDetector</a></div><div class="ttdeci">gpio_num_t smokeDetector</div><div class="ttdef"><b>Definition:</b> main.c:43</div></div>
<div class="ttc" id="astructfire__alarm__t_html_a4afb679790ccaa02ebc3ff69cc0ad2aa"><div class="ttname"><a href="../../d8/db4/structfire__alarm__t.html#a4afb679790ccaa02ebc3ff69cc0ad2aa">fire_alarm_t::active</a></div><div class="ttdeci">bool active</div><div class="ttdef"><b>Definition:</b> main.c:45</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md38"></a>
C helpful functions</h1>
<p >For this lab, there are a couple of additional functions from <code>Espressif</code> that are important for using inputs. In the previous lab, we had used <code>gpio_set_direction(gpio_num_t gpio_num, gpio_mode_t mode)</code> set our inputs and outputs. However, will now use a different approach by using <code>gpio_config_t</code>. This new apporach allows users to create inputs and outputs in a more condense fashion with structures. The structure has various members with their own data types. Please look into them in order to select the correct values when developing the lab. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    uint64_t pin_bit_mask;          </div>
<div class="line">    gpio_mode_t mode;               </div>
<div class="line">    gpio_pullup_t pull_up_en;       </div>
<div class="line">    gpio_pulldown_t pull_down_en;   </div>
<div class="line">    gpio_int_type_t intr_type;      </div>
<div class="line">} gpio_config_t;</div>
</div><!-- fragment --><p >There are significant difference in how to set the interrupts. Here is a brief description of pull-up and pull-down to help you for the lab. </p><div align="center"> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Interrupt Configuration   </th><th class="markdownTableHeadLeft">Description   </th><th class="markdownTableHeadLeft">Logic    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>Pull-up</b>   </td><td class="markdownTableBodyLeft">Falling edge   </td><td class="markdownTableBodyLeft"><b>1</b> -&gt; <b>0</b>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>Pull-down</b>   </td><td class="markdownTableBodyLeft">Rising edge   </td><td class="markdownTableBodyLeft"><b>0</b> -&gt; <b>1</b>   </td></tr>
</table>
</div><p >For this lab will we keep the interrupt flag to its default settings which would be <code>0</code>. In order to set the interrupt flag, the following function is required: <code>gpio_install_isr_service(int intr_alloc_flags)</code>. </p><div class="fragment"><div class="line">esp_err_t gpio_install_isr_service(<span class="keywordtype">int</span> intr_alloc_flags)</div>
</div><!-- fragment --><p >Lastly, <code>static void IRAM_ATTR gpio_isr_handler(void* arg)</code> is the interrupt service routine and can be modified if necessary as long as it has <code>IRAM_ATTR</code> which it is required for interrupts. Also, in order to add any input to enter the interrupt routine, you must <code>add</code> it to isr handler: <code>gpio_isr_handler_add(gpio_num_t gpio_num, gpio_isr_t isr_handler, void *args)</code>. </p><div class="fragment"><div class="line">esp_err_t gpio_isr_handler_add(gpio_num_t gpio_num, gpio_isr_t isr_handler, <span class="keywordtype">void</span> *args)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Warning</h1>
<p >The bit mask in <code>gpio_config_t</code> is an <code>uint64_t</code> value and ESP32 uses <code>enum</code> for its pinout. Therefore, in order to mask the bits correctly you must bit shift the desire pin by an unsigned long long (<code>ULL</code>). </p><div class="fragment"><div class="line"><span class="preprocessor">#define ONBOARD_LED     2 </span><span class="comment">/* ESP32 onboard led */</span><span class="preprocessor"></span></div>
<div class="line">uint64_t bitmask = (1ULL &lt;&lt; <a class="code hl_define" href="../../d2/d6b/_lab__2_2main_2main_8c.html#a547f7691f0e83d2e9fd22bf5b3c08b0a">ONBOARD_LED</a>); <span class="comment">/* Convert onboard led value to unsigned long long */</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md40"></a>
Add led driver to ESP32 Project</h1>
<ol>
<li>
Copy driver folder </li>
<li>
Paste into esp project </li>
<li>
Edit project CMakeLists.txt to use <a class="el" href="../../de/dbb/led_8c.html" title="Custom LED driver source file.">led.c</a>: </li>
</ol>
<div class="fragment"><div class="line">idf_component_register(SRCS &quot;main.c&quot;</div>
<div class="line">                            &quot;driver/led.c&quot;</div>
<div class="line">                    INCLUDE_DIRS &quot;.&quot;)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md41"></a>
Additional Links</h1>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html#">Espressif GPIO Driver API</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md42"></a>
Authors</h1>
<ul>
<li><a href="https://github.com/jminjares4"><b>Jesus Minjares</b></a><ul>
<li><b>Master of Science in Computer Engineering</b> <br  />
 <a href="https://www.linkedin.com/in/jesusminjares/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white&amp;style=flat" alt="LinkedIn" class="inline"/></a> <a href="https://github.com/jminjares4"><img src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&amp;logo=github&amp;logoColor=white&amp;style=flat" alt="GitHub" class="inline"/></a></li>
</ul>
</li>
<li><a href="https://github.com/eabaca2419"><b>Erick Baca</b></a><ul>
<li><b>Master of Science in Computer Engineering</b> <br  />
 <a href="https://www.linkedin.com/in/erick-baca/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white&amp;style=flat" alt="LinkedIn" class="inline"/></a> <a href="https://github.com/eabaca2419"><img src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&amp;logo=github&amp;logoColor=white&amp;style=flat" alt="GitHub" class="inline"/></a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md43"></a>
GitHub</h1>
<div align="left"> <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template/tree/main/Lab_2"><img src="../../github.png" alt="" class="inline"/> </a> <a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template/tree/main/Lab_2">Lab 2 Repository</a> </div><p ><span class="next_section_button"> Read Next: <a class="el" href="../../d3/d14/md_doc_pages_lab3.html">Lab 3</a> </span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
    <ul>
      <li class="footer"><a href="https://github.com/jminjares4/Microprocessor-2-Lab-Template"><img class="footer" src="../../university_of_texas_at_el_paso_logo.png" width="104" height="31" alt="doxygen"/></a> v2.0 </li>
    </ul>
  </div>
  </body>
  </html>
  